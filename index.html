<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–°–∫–∞–Ω–µ—Ä –Ω–æ–º–µ—Ä–æ–≤</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{width:100%;height:100%;font-family:system-ui;background:#050816;display:flex;flex-direction:column;overflow:hidden}
    .header{background:rgba(7,12,40,.96);padding:12px 16px;border-bottom:1px solid rgba(0,220,255,.15);flex-shrink:0}
    .header-title{color:#00d4ff;font-weight:700;font-size:18px}
    .status{color:#8fe9ff;font-size:11px;margin-top:4px}
    .camera-container{flex:1;background:#000;position:relative;min-height:0;overflow:hidden}
    video{width:100%;height:100%;object-fit:cover;display:block}
    canvas{display:none}
    .guide{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);width:85%;height:100px;border:3px dashed #00ff88;border-radius:8px;box-shadow:0 0 20px rgba(0,255,136,.3);pointer-events:none;z-index:5}
    .found{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.9);color:#00ffbf;padding:12px 20px;border-radius:8px;border:2px solid #00ffbf;font-weight:700;font-size:16px;letter-spacing:2px;z-index:20;display:none}
    .control-panel{background:rgba(7,12,40,.97);padding:12px;border-top:1px solid rgba(0,220,255,.15);display:flex;gap:8px;flex-wrap:wrap;flex-shrink:0}
    .btn{padding:10px 12px;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:12px;flex:1;min-width:80px}
    .btn-primary{background:linear-gradient(135deg,#00ff99,#00c8ff);color:#000;flex:2}
    .btn-secondary{background:rgba(0,60,120,.8);color:#8fe9ff;border:1px solid rgba(0,220,255,.5)}
    .btn-danger{background:rgba(120,20,40,.9);color:#ff9b9b}
    .btn:disabled{opacity:.5}
    .database-panel{background:rgba(6,10,32,.98);border-top:1px solid rgba(0,220,255,.15);max-height:0;overflow:hidden;transition:max-height .25s;flex-shrink:0}
    .database-panel.open{max-height:250px}
    .database-content{padding:10px;max-height:240px;overflow-y:auto}
    .plate-item{background:rgba(0,255,153,.1);border:1px solid rgba(0,220,255,.25);padding:8px;border-radius:6px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;font-size:12px}
    .plate-number{color:#00ffbf;font-weight:700;letter-spacing:2px;flex:1}
    .plate-country{font-size:10px;background:rgba(0,255,153,.2);padding:2px 4px;border-radius:3px;color:#00ffbf;margin-left:6px}
  </style>
</head>
<body>
  <div class="header">
    <div class="header-title">üì∑ –°–∫–∞–Ω–µ—Ä –Ω–æ–º–µ—Ä–æ–≤</div>
    <div class="status" id="status">–ì–æ—Ç–æ–≤–æ</div>
  </div>

  <div class="camera-container">
    <video id="video" playsinline autoplay muted></video>
    <canvas id="canvas"></canvas>
    <div class="guide"></div>
    <div class="found" id="found"></div>
  </div>

  <div class="control-panel">
    <button class="btn btn-primary" id="startBtn">‚ñ∂ –ö–ê–ú–ï–†–ê</button>
    <button class="btn btn-secondary" id="detectBtn" disabled>üîç –°–ö–ê–ù–ò–†–û–í–ê–¢–¨</button>
    <button class="btn btn-secondary" id="dbBtn">üìä –ë–ê–ó–ê</button>
    <button class="btn btn-danger" id="clearBtn">üóë</button>
  </div>

  <div class="database-panel" id="databasePanel">
    <div class="database-content">
      <div style="color:#74dfff;font-size:12px;margin-bottom:8px;font-weight:600">üìã –ù–æ–º–µ—Ä–∞:</div>
      <div id="platesList" style="color:#5275a0;font-size:12px;text-align:center">–ù–µ—Ç –Ω–æ–º–µ—Ä–æ–≤</div>
    </div>
  </div>

  <script async src="https://cdn.jsdelivr.net/npm/ml5@latest/dist/ml5.min.js"></script>
  <script>
    const state = {
      stream: null,
      plates: new Map(),
      active: false,
      detecting: false,
      detectionInterval: null,
      lastDetected: new Map()
    };

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    const status = document.getElementById('status');
    const startBtn = document.getElementById('startBtn');
    const detectBtn = document.getElementById('detectBtn');
    const dbBtn = document.getElementById('dbBtn');
    const clearBtn = document.getElementById('clearBtn');
    const platesList = document.getElementById('platesList');
    const found = document.getElementById('found');
    const databasePanel = document.getElementById('databasePanel');

    // –†—É—Å—Å–∫–∏–µ –±—É–∫–≤—ã –≤ –Ω–æ–º–µ—Ä–∞—Ö
    const RU_PATTERN = /^[–ê–í–ï–ö–ú–ù–û–†–°–¢–£–•–£]d{3}[–ê–í–ï–ö–ú–ù–û–†–°–¢–£–•–£]{2}d{2,3}$/;
    const EU_PATTERN = /^[A-Z]{1,3}d{1,4}[A-Z]{1,3}$/;

    function classifyPlate(text) {
      text = text.toUpperCase().replace(/[s-.O0]/g, (m) => {
        if (m === 'O') return '0'; // O ‚Üí 0
        return m;
      }).trim();

      if (RU_PATTERN.test(text)) return { plate: text, country: 'RU' };
      if (EU_PATTERN.test(text)) return { plate: text, country: 'EU' };
      if (/^[A-Z0-9]{4,8}$/.test(text)) return { plate: text, country: 'USA' };
      return null;
    }

    startBtn.onclick = async () => {
      if (state.active) {
        if (state.stream) {
          state.stream.getTracks().forEach(t => t.stop());
        }
        state.active = false;
        startBtn.textContent = '‚ñ∂ –ö–ê–ú–ï–†–ê';
        detectBtn.disabled = true;
        status.textContent = '–ö–∞–º–µ—Ä–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞';
        return;
      }

      try {
        status.textContent = '‚è≥ –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞...';
        
        state.stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } },
          audio: false
        });

        video.srcObject = state.stream;
        
        video.onloadedmetadata = async () => {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          await video.play();
          state.active = true;
          startBtn.textContent = '‚è∏ –í–´–ö–õ–Æ–ß–ò–¢–¨';
          detectBtn.disabled = false;
          status.textContent = '‚úì –ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞';
        };

      } catch (e) {
        status.textContent = '‚ùå ' + e.message;
      }
    };

    detectBtn.onclick = async () => {
      if (state.detecting) {
        stopDetection();
      } else {
        startDetection();
      }
    };

    function startDetection() {
      state.detecting = true;
      detectBtn.textContent = '‚èπ –û–°–¢–ê–ù–û–í–ò–¢–¨';
      status.textContent = 'üîç –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ';
      state.detectionInterval = setInterval(captureFrame, 2000);
    }

    async function captureFrame() {
      if (!state.detecting || !state.active) return;

      try {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // –û–±—Ä–µ–∑–∞–µ–º –æ–±–ª–∞—Å—Ç—å –Ω–æ–º–µ—Ä–∞
        const x = canvas.width * 0.05;
        const y = canvas.height * 0.6;
        const w = canvas.width * 0.9;
        const h = 120;

        const imageData = ctx.getImageData(x, y, w, h);

        // –£–ª—É—á—à–∞–µ–º –∫–æ–Ω—Ç—Ä–∞—Å—Ç
        enhanceContrast(imageData.data);

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ Cloud OCR (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Å–µ—Ä–≤–∏—Å)
        canvas.toBlob(async (blob) => {
          try {
            const formData = new FormData();
            formData.append('upload', blob);

            const response = await fetch('https://api.platerecognizer.com/v1/plate-reader/', {
              method: 'POST',
              headers: {
                'Authorization': 'Token 2a4adc1c8f8f33e4f5c6d7e8f9g0h1i2j'
              },
              body: formData
            }).catch(() => null);

            if (response && response.ok) {
              const data = await response.json();
              if (data.results && data.results.length > 0) {
                const result = data.results[0];
                const plate = result.plate.toUpperCase();
                const conf = Math.round(result.confidence * 100);
                
                if (plate && plate.length >= 4) {
                  const detected = classifyPlate(plate);
                  if (detected) {
                    const lastTime = state.lastDetected.get(detected.plate) || 0;
                    if (Date.now() - lastTime > 5000) {
                      state.lastDetected.set(detected.plate, Date.now());
                      addPlate(detected.plate, detected.country, conf);
                    }
                  }
                }
              }
            }
          } catch (e) {
            console.log('API unavailable');
          }
        }, 'image/jpeg', 0.95);
      } catch (e) {
        console.error(e);
      }
    }

    function enhanceContrast(data) {
      for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];
        
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —á/–±
        const gray = r * 0.299 + g * 0.587 + b * 0.114;
        const bw = gray > 120 ? 255 : 0;
        
        data[i] = bw;
        data[i + 1] = bw;
        data[i + 2] = bw;
      }
    }

    function addPlate(plate, country, conf = 85) {
      if (state.plates.has(plate)) return;

      const time = new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
      state.plates.set(plate, { time, country, conf });

      found.textContent = plate;
      found.style.display = 'block';
      setTimeout(() => { found.style.display = 'none'; }, 2500);

      status.textContent = `‚úì ${country}: ${plate}`;
      updateList();
    }

    function stopDetection() {
      state.detecting = false;
      if (state.detectionInterval) clearInterval(state.detectionInterval);
      detectBtn.textContent = 'üîç –°–ö–ê–ù–ò–†–û–í–ê–¢–¨';
    }

    dbBtn.onclick = () => databasePanel.classList.toggle('open');

    clearBtn.onclick = () => {
      state.plates.clear();
      updateList();
      status.textContent = '‚úì –ë–∞–∑–∞ –æ—á–∏—â–µ–Ω–∞';
    };

    function updateList() {
      if (state.plates.size === 0) {
        platesList.textContent = '–ù–µ—Ç –Ω–æ–º–µ—Ä–æ–≤';
        return;
      }

      platesList.innerHTML = Array.from(state.plates).map(([plate, data]) => `
        <div class="plate-item">
          <div class="plate-number">${plate}</div>
          <span class="plate-country">${data.country}</span>
          <span style="font-size:10px;color:#6fb9ff;margin-left:6px">${data.conf}%</span>
        </div>
      `).join('');
    }

    window.onbeforeunload = () => {
      if (state.stream) state.stream.getTracks().forEach(t => t.stop());
    };
  </script>
</body>
</html>
